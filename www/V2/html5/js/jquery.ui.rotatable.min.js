(function(b,d){b.widget("ui.rotatable",b.ui.mouse,{options:{handle:!1,angle:!1,start:null,rotate:null,stop:null},handle:function(a){if(a===d)return this.options.handle;this.options.handle=a},angle:function(a){if(a===d)return this.options.angle;this.options.angle=a;this.performRotation(this.options.angle)},_create:function(){var a;this.options.handle?a=this.options.handle:(a=b(document.createElement("div")),a.addClass("ui-rotatable-handle ctrlElem"));this.listeners={rotateElement:b.proxy(this.rotateElement,
this),startRotate:b.proxy(this.startRotate,this),stopRotate:b.proxy(this.stopRotate,this)};a.draggable({helper:"clone",start:this.dragStart,handle:a});a.bind("mousedown",this.listeners.startRotate);a.appendTo(this.element);0!=this.options.angle?(this.elementCurrentAngle=this.options.angle,this.performRotation(this.elementCurrentAngle)):this.elementCurrentAngle=0},_destroy:function(){this.element.removeClass("ui-rotatable");this.element.find(".ui-rotatable-handle").remove()},performRotation:function(a){this.element.css("transform",
"rotate("+a+"rad)");this.element.css("-moz-transform","rotate("+a+"rad)");this.element.css("-webkit-transform","rotate("+a+"rad)");this.element.css("-o-transform","rotate("+a+"rad)")},getElementOffset:function(){this.performRotation(0);var a=this.element.offset();this.performRotation(this.elementCurrentAngle);return a},getElementCenter:function(){var a=this.getElementOffset(),c=a.left+this.element.width()/2,a=a.top+this.element.height()/2;return[c,a]},dragStart:function(a){if(this.element)return!1},
startRotate:function(a){var c=this.getElementCenter();this.mouseStartAngle=Math.atan2(a.pageY-c[1],a.pageX-c[0]);this.elementStartAngle=this.elementCurrentAngle;this.hasRotated=!1;this._propagate("start",a);b(document).bind("mousemove",this.listeners.rotateElement);b(document).bind("mouseup",this.listeners.stopRotate);return!1},rotateElement:function(a){if(!this.element||this.element.disabled)return!1;var c=this.getElementCenter(),c=Math.atan2(a.pageY-c[1],a.pageX-c[0])-this.mouseStartAngle+this.elementStartAngle;
if(a.shiftKey){var b=15/180*Math.PI;0>c&&(b*=-1);c-=(c+b/2)%b-b/2}this.performRotation(c);b=this.elementCurrentAngle;this.elementCurrentAngle=c;this._propagate("rotate",a);b!=c&&(this._trigger("rotate",a,this.ui()),this.hasRotated=!0);return!1},stopRotate:function(a){if(this.element&&!this.element.disabled)return b(document).unbind("mousemove",this.listeners.rotateElement),b(document).unbind("mouseup",this.listeners.stopRotate),this.elementStopAngle=this.elementCurrentAngle,this.hasRotated&&this._propagate("stop",
a),setTimeout(function(){this.element=!1},10),!1},_propagate:function(a,c){b.ui.plugin.call(this,a,[c,this.ui()]);"rotate"!==a&&this._trigger(a,c,this.ui())},plugins:{},ui:function(){return{element:this.element,angle:{start:this.elementStartAngle,current:this.elementCurrentAngle,stop:this.elementStopAngle}}}})})(jQuery);