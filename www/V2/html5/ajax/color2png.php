<?phpheader('Content-Type: text/html; charset=utf-8');session_start();/*if ( 'POST' == $_SERVER['REQUEST_METHOD'] ) {	if ( isset( $_SERVER['HTTP_ORIGIN'] ) ) {		$address = 'http://' . $_SERVER['SERVER_NAME'];		if ( strpos( $address, $_SERVER['HTTP_ORIGIN'] ) !== 0 ) {			exit( 'CSRF protection in POST request: detected invalid Origin header: ' . $_SERVER['HTTP_ORIGIN'] );		}	}}*/error_reporting(E_ALL);ini_set('display_errors', '1');if ( isset( $_SESSION['prodID'] ) ) $productID = $_SESSION['prodID']; else	die();$image = '../img/motifs/svg/' . $_POST['fileName'];if(strstr($_POST['fileName'], ".svg")){    $color = $_POST['fileColor'];        if($color){            $image=countfill($image,$color);            $imageData = base64_encode($image);        $src = 'data:image/svg+xml;base64,'.$imageData;        $svg="1";         $data = array(		'imgMotif'		=> $src,                'contentsvg'            => $image,                'svg'			=> $svg,	);        }else{          $imageData = base64_encode(file_get_contents($image));        $src = 'data:image/svg+xml;base64,'.$imageData;          $svg="1";         $data = array(		'imgMotif'		=> $src,                'contentsvg'            => file_get_contents($image),                'svg'			=> $svg,	);        }                                 	echo json_encode( $data );}else{if ( isset( $_POST['fileName'] ) AND file_exists( '../img/motifs/' . $_POST['folder'] . '/' . $_POST['fileName'] ) AND $_POST['fileColor'] != '' ) :	$getFile = '../img/motifs/' . $_POST['folder'] . '/' . $_POST['fileName'];	/*$getFile = '../img/motifs/' . $_POST['fileName'];*/	$color = $_POST['fileColor'];	$id = $_POST['id'];	$_SESSION['rapidpub'][$productID]['motif'][$id]['color'] = $color;	$im = new Imagick( $getFile );	if ( isset( $_POST['vitType'] ) AND $_POST['vitType'] == 'adhesif-microperfore' )		$im->evaluateImage(Imagick::EVALUATE_MULTIPLY, 0.85, Imagick::CHANNEL_ALPHA);	$im->setImageAlphaChannel( Imagick::ALPHACHANNEL_EXTRACT );	$im->setImageBackgroundColor( $color);	$im->setImageAlphaChannel( Imagick::ALPHACHANNEL_SHAPE );	$im->trimImage( 0 );	//$im->floodFillPaintImage( 'black', 10, 'red', 0, 0, false );            $src=base64_encode( $im->getImageBlob() );    echo $src;		$im->clear();	$im->destroy();endif;}function countfill($image,$color){   $nbfill= substr_count(file_get_contents($image),"fill");   $svgOutput=RecolorImage($image, $color);   if($nbfill>1){//        $svgOutput = preg_replace(//         '/#([0-9a-f]{6})/i',//        '#'.$color,//        file_get_contents($image)//    );       $svgOutput=RecolorImage($image, $color);   }     return $svgOutput;}function RecolorImage($ImageSvgFile, $ImageColor) {    $FileContents = file_get_contents($ImageSvgFile);    $doc = new DOMDocument();    $dom->preserveWhiteSpace = False;    $doc->loadXML($FileContents) or die('Failed to load SVG file ' . $ImageSvgFile . ' as XML.  It probably contains malformed data.');    $SvgTags = $doc->getElementsByTagName("svg");//    if (preg_match('/^([0-9a-f]{1,2}){3}$/i', $ImageColor) == false)//        {//        die('Invalid color: ' . $ImageColor);//        }    //Look at each element in the XML and add or replace it's Fill attribute to change the color.    $arrayelement = array("rect", "circle", "path");    $arraycolor=array();    foreach ($arrayelement as $value) {        $AllTags = $doc->getElementsByTagName($value);         foreach ($AllTags as $ATag) {            $VectorColor = $ATag->getAttribute('fill');            $StrokeColor = $ATag->getAttribute('stroke');            if (strtoupper($VectorColor) != '#FFFFFF' && strtoupper($VectorColor) != 'none' &&                    strtoupper($StrokeColor) != '#FFFFFF' && strtoupper($StrokeColor) != 'none') {                //This vector is not white, so change it's color.                 array_push($arraycolor,strtoupper($VectorColor));                 array_push($arraycolor,strtoupper($StrokeColor));            }        }        $arrayunique=array_unique($arraycolor);        //print_r($arrayunique);        if(count($arrayunique)==1){        /**********************/        foreach ($AllTags as $ATag) {            $VectorColor = $ATag->getAttribute('fill');            $StrokeColor = $ATag->getAttribute('stroke');            if (strtoupper($VectorColor) != '#FFFFFF' && strtoupper($VectorColor) != 'none' &&                    strtoupper($StrokeColor) != '#FFFFFF' && strtoupper($StrokeColor) != 'none') {                //This vector is not white, so change it's color.                $ATag->setAttribute('fill', '' . $ImageColor);                $ATag->setAttribute('stroke', '' . $ImageColor);                $FileContents = $doc->saveXML($doc);            }        }    }    }    Return $FileContents;}