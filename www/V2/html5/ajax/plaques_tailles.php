<?phpheader('Content-Type: text/html; charset=utf-8');session_start();if ( 'POST' == $_SERVER['REQUEST_METHOD'] ) {	if ( isset( $_SERVER['HTTP_ORIGIN'] ) ) {		$address = 'http://' . $_SERVER['SERVER_NAME'];		if ( strpos( $address, $_SERVER['HTTP_ORIGIN'] ) !== 0 ) {			exit( 'CSRF protection in POST request: detected invalid Origin header: ' . $_SERVER['HTTP_ORIGIN'] );		}	}}$session = md5( session_id()+time() );if ( isset( $_SESSION['prodID'] ) ) $productID = $_SESSION['prodID']; else	die();//require_once( '../includes/connexion.php' );//require_once( '../includes/functions.php' );if( !isset($DB_site) ){    require_once("../../global.php");}if (isset($_POST['action'])) {   $action = $_POST['action'];} else if(isset($_GET['action'])) {   $action = $_GET['action'];}if (isset($_POST['type'])) {   $typeData = $_POST['type'];} else if(isset($_GET['type'])) {   $typeData = $_GET['type'];}/** ---- init prix ---- **/$prixValue = 0.00;$prixDimensionMatiere = 0.00;$prixOptionImage = 0.00;$prixAucuneFixation = 0.00;$prixFixationAdhesif = 0.00;/**---- init prix ------ **/#----- START PRIX par DIMENSION & MATIERE ----- if( isset($action) AND $action == "edit_prix"   ) {	if ( isset( $_POST['id'] ) AND is_numeric( $_POST['id'] ) AND isset( $_POST['matiere'] ) AND is_numeric( $_POST['matiere'] ) ) {		$id = (int) $_POST['id'];		$matiere = (int) $_POST['matiere'];		$prixarticlemodule = $DB_site->query_first("select * from tarifs_plaques WHERE dimensions =$id AND id_matiere =$matiere");		$prixDimensionMatiere = $prixarticlemodule['prix_constate'];	}}#----- END PRIX par DIMENSION & MATIERE ----- #----- START PRIX par AJOUT IMAGE -----if( isset($action) AND $action == "add_prix_image"   ) {	if( isset($typeData) AND $typeData == "image"   ) {			if ( isset( $_SESSION['rapidpub'][$productID]['image'] ) AND !empty( $_SESSION['rapidpub'][$productID]['image'] ) ) {			$elemT = $_SESSION['rapidpub'][$productID]['image'];			$iCountElemt = count($elemT);			//print_r($iCountElemt);			if($iCountElemt == 0){				$prixOptionImage = 25;			}		}	}} #----- START PRIX par AJOUT IMAGE -----#----- START PRIX par  SUPP IMAGE -----if( isset($action) AND $action == "del_prix_image"   ) {	if( isset($typeData) AND $typeData == "image"   ) {			if ( isset( $_SESSION['rapidpub'][$productID]['image'] ) AND !empty( $_SESSION['rapidpub'][$productID]['image'] ) ) {			$elemT = $_SESSION['rapidpub'][$productID]['image'];			$iCountElemt = count($elemT);			//print_r($iCountElemt);			if($iCountElemt == 0){				$prixOptionImage = -25;			}		}	}} #----- END PRIX par AJOUT  IMAGE ------- $data = array();// $row = $DB_site->query_first("select * from tarifs_plaques WHERE id =$id");$row = $DB_site->query_first("select * from tarifs_plaques WHERE dimensions =$id"); $cm2pxl = '37.795276';$maxL = 760;$maxH = 480;$newL = ($row['longueur'] * $cm2pxl)/2;$newH = ($row['hauteur'] * $cm2pxl)/2;if ( $row['longueur'] > $row['hauteur'] )	$orientation = 'h';else	$orientation = 'v';if ( $newL > $maxL OR $newH > $maxH ) {	if ( $row['longueur'] == $row['hauteur'] ) {		$width = 500;		$height = 500;	} elseif ( $row['longueur'] > $row['hauteur'] ) {		$ratio = $newH / $newL;		$width = $maxL;		$height = $maxL * $ratio;	} elseif ( $row['hauteur'] > $row['longueur'] ) {		$ratio = $newL / $newH;		$height = $maxH;		$width = $maxH * $ratio;	}} else {	if ( $row['longueur'] < $row['hauteur'] ) {		$ratio = $maxH / $newH;		$width = $newL * $ratio;		$height = $maxH;	} elseif ( $row['hauteur'] < $row['longueur'] ) {		$ratio = $newH / $newL;		$width = $maxL;		$height = $maxH * $ratio;	} elseif ($row['hauteur'] == $row['longueur'] ) {		$width = 500;		$height = 500;	}}/** ----------- init session  fixation ---------**/$_SESSION['no_fixing'] = $prixValue;$_SESSION['adhesif_fixing'] = $prixValue;/** ----------- init session  fixation ---------**//**-- Somme prix final --- **/$prixValue = $prixDimensionMatiere + $prixOptionImage + $prixAucuneFixation + $prixFixationAdhesif ;/**-- Somme prix final --- **/$data = array(	'id'				=> $row['id'],	//'prix' 				=> $row['prix'],	'prix' 				=> $prixValue,	//'dimensions'		=> $row['dimensions'],	'dimensions'		=> $row['longueur']."x".$row['hauteur'],	'newL'				=> $newL,	'newH'				=> $newH,	'hauteur'			=> $row['hauteur'],	'longueur'			=> $row['longueur'],	'orientation'		=> $orientation,	'entretoises'		=> $row['entretoises'],	'height'			=> round( $height ),	'width'				=> round( $width ),	'prix_constate'		=> $row['prix_constate'],	'entretoise_gauche' => $row['entretoise_gauche'],	'entretoise_droite'	=> $row['entretoise_droite']);/** launch data JSON **/echo json_encode( $data );/** launch data JSON **/?>